<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link rel="stylesheet" href="stylesheets/admin.css" />
  </head>

  <body>
    <div id="access-denied" class="hidden">
      <p id="dn">Access Denied</p>
    </div>
    <div class="hidden" id="admin-content">
      <div class="sidebar">
        <h2>Admin Panel</h2>
        <ul>
          <li><a href="#dashboard">Dashboard</a></li>
          <li><a href="#users">Users</a></li>
          <li><a href="#products">Products</a></li>
          <li><a href="#orders">Orders</a></li>
          <li><a href="#reports">Reports</a></li>
        </ul>
      </div>
      <div class="content">
        <div id="dashboard" class="section active">
          <h2>Dashboard</h2>
          <p>Welcome to the admin panel.</p>
          <div class="stats">
            <div class="stat-card" id="user-count">
              <h3>Total Users</h3>
              <p id="user-count-value">Loading...</p>
            </div>
            <div class="stat-card" id="order-count">
              <h3>Orders in Process</h3>
              <p id="order-count-value">Loading...</p>
            </div>
            <div class="stat-card" id="product-count">
              <h3>Available Products</h3>
              <p id="product-count-value">Loading...</p>
            </div>
          </div>
        </div>

        <div id="users" class="section">
          <h2>Users</h2>
          <!-- Add this inside the 'Users' section in admin.html -->
          <div id="add-user-form" class="user-form">
            <h3>Add New User</h3>
            <div class="input-box">
              <input
                type="text"
                id="name"
                placeholder="Enter your name"
                required
              />
            </div>
            <div class="input-box">
              <input
                type="email"
                id="email"
                placeholder="Enter your email"
                required
              />
            </div>
            <div class="input-box">
              <input
                type="password"
                id="password"
                placeholder="Create password"
                required
              />
            </div>
            <div class="input-box">
              <input
                type="password"
                id="confirm-password"
                placeholder="Confirm password"
                required
              />
            </div>
            <div class="input-box">
              <input
                type="text"
                id="address"
                placeholder="Enter Address"
                required
              />
            </div>
            <div class="input-box">
              <input
                type="tel"
                id="contact"
                placeholder="Contact Number"
                required
              />
            </div>
            <label for="user-role">Choose a Role:</label>
            <select id="user-role" name="user-role" required>
              <option value="admin">Admin</option>
              <option value="editor">Editor</option>
              <option value="user">User</option>
            </select>
            <button id="add-user-btn">Add User</button>
          </div>
          <h2>current users:</h2>
          <ul id="users-list"></ul>
        </div>
        <div id="products" class="section">
          <h2>Products</h2>
          <ul id="products-list" style="display: flex; gap: 2rem"></ul>
          <div id="edit-product-form" class="product-form hidden">
            <h3>Edit Product</h3>
            <input
              type="text"
              id="edit-product-name"
              placeholder="Product Name"
              required
            />
            <textarea
              id="edit-product-description"
              placeholder="Product Description"
            ></textarea>
            <input
              type="number"
              id="edit-product-price"
              placeholder="Product Price"
              required
            />
            <input
              type="number"
              id="edit-product-stock"
              placeholder="Stock Quantity"
              required
            />
            <label for="edit-options">Choose a Category:</label>
            <select id="edit-options" name="edit-options" required>
              <option value="bags">bags</option>
              <option value="beauty">beauty</option>
              <option value="clothing">clothing</option>
              <option value="Jewelry">Jewelry</option>
              <option value="shoes">shoes</option>
            </select>
            <br />
            <label for="edit-options2">Choose a Brand:</label>
            <select id="edit-options2" name="edit-options2" required>
              <option value="Gul Ahmed">Gul Ahmed</option>
              <option value="Khaadi">Khaadi</option>
              <option value="Junaid Jamshed">Junaid Jamshed</option>
              <option value="limelight">limelight</option>
              <option value="beechtree">beechtree</option>
            </select>
            <br />
            <button id="save-product-btn">Save Changes</button>
            <button id="nvm-product-btn" style="background-color: red">
              <i class="fa-solid fa-x"></i>
            </button>
          </div>
          <div id="product-form" class="product-form">
            <h3>Add New Product</h3>
            <input
              type="text"
              id="product-name"
              placeholder="Product Name"
              required
            />
            <textarea
              id="product-description"
              placeholder="Product Description"
            ></textarea>
            <input
              type="number"
              id="product-price"
              placeholder="Product Price"
              required
            />
            <input
              type="number"
              id="product-stock"
              placeholder="Stock Quantity"
              required
            />
            <!-- <input
            type="text"
            id="product-link"
            placeholder="Product Link"
            required
          /> -->
            <input
              type="file"
              id="imageUpload"
              name="imageUpload"
              accept="image/*"
            />

            <label for="options">Choose a Category:</label>
            <select id="options" name="options" required>
              <option value="bags">bags</option>
              <option value="beauty">beauty</option>
              <option value="clothing">clothing</option>
              <option value="Jewelry">Jewelry</option>
              <option value="shoes">shoes</option>
            </select>
            <br />
            <label for="options2">Choose a brand:</label>
            <select id="options2" name="options2" required>
              <option value="Gul Ahmed">Gul Ahmed</option>
              <option value="Khaadi">Khaadi</option>
              <option value="Junaid Jamshed">Junaid Jamshed</option>
              <option value="limelight">limelight</option>
              <option value="beechtree">beechtree</option>
            </select>
            <br />
            <button id="add-product-btn">Add Product</button>
          </div>
        </div>
        <div id="orders" class="section">
          <h2>Orders</h2>
          <ul id="orders-list"></ul>
        </div>
      </div>

      <script>
        async function deleteProduct(productId) {
          if (confirm("Are you sure you want to delete this product?")) {
            try {
              const response = await fetch(
                `http://localhost:5000/api/products/${productId}`,
                {
                  method: "DELETE",
                }
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();

              if (data.success) {
                // Remove the product from the frontend list
                fetchProducts();
              } else {
                alert("Failed to delete the product: " + data.message);
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred while trying to delete the product.");
            }
          }
        }

        async function deleteOrder(orderId, index) {
          if (confirm("Are you sure you want to delete this order?")) {
            try {
              const response = await fetch(
                `http://localhost:5000/api/orders/${orderId}`,
                {
                  method: "DELETE",
                }
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();

              if (data.success) {
                // Remove the order from the frontend list
                window.location.reload();
              } else {
                alert("Failed to delete the order: " + data.message);
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred while trying to delete the order.");
            }
          }
        }

        document.addEventListener("DOMContentLoaded", function () {
          // Token check
          const token = localStorage.getItem("token");
          if (!token) {
            // window.location.href = "login.html"
            console.log("bad tokenx");
            return;
          }

          // Function to validate token and check user role
          async function validateToken() {
            try {
              const response = await fetch(
                "http://localhost:5000/api/users/validate-token",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                }
              );

              if (!response.ok) {
                throw new Error("Invalid token");
              }

              const user = await response.json();
              console.log("User data:", user); // Debugging line

              // Check user role
              if (user.role === "admin" || user.role === "editor") {
                document
                  .getElementById("admin-content")
                  .classList.remove("hidden");
                document
                  .getElementById("access-denied")
                  .classList.add("hidden");

                // Load the dashboard stats
                fetchDashboardStats();
              } else {
                window.location.href = "index.html";

                document
                  .getElementById("admin-content")
                  .classList.add("hidden");
                document
                  .getElementById("access-denied")
                  .classList.remove("hidden");
              }
            } catch (error) {
              console.error("Token validation failed:", error);
              window.location.href = "login.html";
            }
          }

          // Call the function to validate the token and user role
          validateToken();
          const sections = document.querySelectorAll(".section");
          const navLinks = document.querySelectorAll(".sidebar ul li a");

          async function fetchDashboardStats() {
            try {
              // Fetch statistics from your backend API
              const [usersResponse, ordersResponse, productsResponse] =
                await Promise.all([
                  fetch("http://localhost:5000/api/stats/users/stats"),
                  fetch("http://localhost:5000/api/stats/orders/stats"),
                  fetch("http://localhost:5000/api/stats/products/stats"),
                ]);

              // Check if all responses are OK
              if (
                !usersResponse.ok ||
                !ordersResponse.ok ||
                !productsResponse.ok
              ) {
                throw new Error("Network response was not ok");
              }

              // Parse the JSON data from responses
              const userStats = await usersResponse.json();
              const orderStats = await ordersResponse.json();
              const productStats = await productsResponse.json();

              // Update the DOM with fetched data
              document.getElementById("user-count-value").textContent =
                userStats.userCount; // Change this to match your actual data structure
              document.getElementById("order-count-value").textContent =
                orderStats.orderCount; // Change this to match your actual data structure
              document.getElementById("product-count-value").textContent =
                productStats.productCount; // Change this to match your actual data structure
            } catch (error) {
              console.error("Failed to fetch dashboard statistics:", error);
              document.getElementById("user-count-value").textContent = "Error";
              document.getElementById("order-count-value").textContent =
                "Error";
              document.getElementById("product-count-value").textContent =
                "Error";
            }
          }

          // Call the function to populate statistics
          fetchDashboardStats();

          navLinks.forEach((link) => {
            link.addEventListener("click", function (event) {
              event.preventDefault();
              const targetSection = document.querySelector(
                this.getAttribute("href")
              );

              sections.forEach((section) => section.classList.remove("active"));
              targetSection.classList.add("active");

              if (this.getAttribute("href") === "#users") {
                fetchUsers();
              } else if (this.getAttribute("href") === "#products") {
                fetchProducts();
              } else if (this.getAttribute("href") === "#orders") {
                fetchOrders();
              }
            });
          });

          async function fetchUsers() {
            try {
              const response = await fetch("http://localhost:5000/api/users");
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              const users = await response.json();
              displayUsers(users);
            } catch (error) {
              console.error("Failed to fetch users:", error);
            }
          }

          function displayUsers(users) {
            const usersList = document.getElementById("users-list");
            usersList.innerHTML = users
              .map(
                (user) => `
                          <li>
                            ${user.name} (${user.email})
                   <select class="role-select" data-id="${user._id}">
                    <option value="admin" ${
                      user.role === "admin" ? "selected" : ""
                    }>Admin</option>
                    <option value="editor" ${
                      user.role === "editor" ? "selected" : ""
                    }>Editor</option>
                    <option value="user" ${
                      user.role === "user" ? "selected" : ""
                    }>User</option>
                  </select>
                            <i class="fa-solid fa-trash" data-id="${
                              user._id
                            }"></i>
                          </li>`
              )
              .join("");

            // Add event listener for role change
            document.querySelectorAll(".role-select").forEach((select) => {
              select.addEventListener("change", async function () {
                const userId = this.getAttribute("data-id");
                const newRole = this.value;
                await changeUserRole(userId, newRole);
                fetchUsers(); // Refresh the user list
              });
            });

            document.querySelectorAll(".fa-trash").forEach((icon) => {
              icon.addEventListener("click", async function () {
                const userId = this.getAttribute("data-id");
                await deleteUser(userId);
                fetchUsers();
              });
            });
          }

          async function changeUserRole(userId, newRole) {
            try {
              const response = await fetch(
                `http://localhost:5000/api/users/${userId}`,
                {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ role: newRole }),
                }
              );

              if (!response.ok) {
                throw new Error("Failed to update user role");
              }

              const updatedUser = await response.json();
              console.log("User role updated:", updatedUser);
            } catch (error) {
              console.error("Failed to change user role:", error);
            }
          }

          async function deleteUser(userId) {
            try {
              const response = await fetch(
                `http://localhost:5000/api/users/${userId}`,
                {
                  method: "DELETE",
                }
              );
              if (!response.ok) {
                throw new Error(
                  `Network response was not ok: ${response.statusText}`
                );
              }
            } catch (error) {
              console.error("Failed to delete user:", error);
            }
          }
          async function editProduct(productId) {
            try {
              const response = await fetch(
                `http://localhost:5000/api/products/${productId}`
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const product = await response.json();

              // Populate the edit form with product data
              document.getElementById("edit-product-name").value = product.name;
              document.getElementById("edit-product-description").value =
                product.description;
              document.getElementById("edit-product-price").value =
                product.price;
              document.getElementById("edit-product-stock").value =
                product.stock;
              document.getElementById("edit-options").value = product.category;
              document.getElementById("edit-options2").value = product.brand;

              // Show the edit form
              document
                .getElementById("edit-product-form")
                .classList.remove("hidden");

              // Set up the save button
              document
                .getElementById("save-product-btn")
                .addEventListener("click", function () {
                  saveProductChanges(productId);
                });
              document
                .getElementById("nvm-product-btn")
                .addEventListener("click", function () {
                  document
                    .getElementById("edit-product-form")
                    .classList.add("hidden");
                });
            } catch (error) {
              console.error("Error fetching product data:", error);
            }
          }

          async function delProduct(productId) {
            try {
              const response = await fetch(
                `http://localhost:5000/api/products/${productId}`,
                {
                  method: "DELETE",
                }
              );
              if (!response.ok) {
                throw new Error(
                  `Network response was not ok: ${response.statusText}`
                );
              }
            } catch (error) {
              console.error("Failed to delete product:", error);
            }
          }
          async function saveProductChanges(productId) {
            const updatedProduct = {
              name: document.getElementById("edit-product-name").value,
              description: document.getElementById("edit-product-description")
                .value,
              price: document.getElementById("edit-product-price").value,
              stock: document.getElementById("edit-product-stock").value,
              category: document.getElementById("edit-options").value,
              brand: document.getElementById("edit-options2").value,
            };

            try {
              const response = await fetch(
                `http://localhost:5000/api/products/${productId}`,
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(updatedProduct),
                }
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const updatedProductData = await response.json();
              console.log("Product updated successfully:", updatedProductData);

              // Hide the edit form and refresh the product list
              document
                .getElementById("edit-product-form")
                .classList.add("hidden");
              fetchProducts();
            } catch (error) {
              console.error("Failed to save product changes:", error);
            }
          }

          async function fetchProducts() {
            try {
              const response = await fetch(
                "http://localhost:5000/api/products"
              );
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              const products = await response.json();
              displayProducts(products);
            } catch (error) {
              console.error("Failed to fetch products:", error);
            }
          }

          function displayProducts(products) {
            const productsList = document.getElementById("products-list");
            productsList.innerHTML = products
              .map(
                (product) => `
      <div class="product-card">
        <img src="${product.productlink}" alt="${product.name}" style="width:100px; height:100px; object-fit:cover;"/>
        <div class="product-details">
          <label>Name:</label>
          <input type="text" value="${product.name}" disabled/><br/>
          <label>Description:</label>
          <input type="text" value="${product.description}" disabled/><br/>
          <label>Price:</label>
          <input type="text" value="${product.price}" disabled/><br/>
          <label>Stock:</label>
          <input type="text" value="${product.stock}" disabled/><br/>
          <label>Category:</label>
          <input type="text" value="${product.category}" disabled/><br/>
          <label>Brand:</label>
          <input type="text" value="${product.brand}" disabled/><br/>
        </div>
        <button class="edit-product-btn" data-id="${product._id}">Edit</button>
        <button class="delete-product-btn" data-id="${product._id}">Delete</button>
      </div>`
              )
              .join("");

            document.querySelectorAll(".edit-product-btn").forEach((button) => {
              button.addEventListener("click", function () {
                const productId = this.getAttribute("data-id");
                editProduct(productId);
              });
            });
            document
              .querySelectorAll(".delete-product-btn")
              .forEach((button) => {
                button.addEventListener("click", function () {
                  const productId = this.getAttribute("data-id");
                  delProduct(productId);
                  fetchProducts();
                });
              });
          }

          // Initial fetch of products
          fetchProducts();
          async function saveProductChanges(productId) {
            const updatedProduct = {
              name: document.getElementById("edit-product-name").value,
              description: document.getElementById("edit-product-description")
                .value,
              price: document.getElementById("edit-product-price").value,
              stock: document.getElementById("edit-product-stock").value,
              category: document.getElementById("edit-options").value,
              brand: document.getElementById("edit-options2").value,
            };

            try {
              const response = await fetch(
                `http://localhost:5000/api/products/${productId}`,
                {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(updatedProduct),
                }
              );

              if (!response.ok) {
                throw new Error("Failed to update product");
              }

              // Hide the product form and refresh the product list
              document.getElementById("product-form").classList.add("hidden");
              fetchProducts();
            } catch (error) {
              console.error("Failed to save product changes:", error);
            }
          }

          async function fetchOrders() {
            try {
              const response = await fetch("http://localhost:5000/api/orders");
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              const orders = await response.json();
              displayOrders(orders);
            } catch (error) {
              console.error("Failed to fetch orders:", error);
            }
          }
          function displayOrders(orders) {
            const ordersList = document.getElementById("orders-list");
            ordersList.innerHTML = orders
              .map(
                (order, index) => `
            <div class="order-card">
              <h3>Order by: ${order.user.firstName} ${order.user.lastName}</h3>
              <div class="order-details">
                <strong>Email:</strong> ${order.user.email}<br/>
                <strong>Address:</strong> ${order.user.address}, ${
                  order.user.city
                }, ${order.user.state} - ${order.user.postalCode}<br/>
                <strong>Phone:</strong> ${order.user.phone}<br/>
                <strong>Order Date:</strong> ${new Date(
                  order.createdAt
                ).toLocaleString()}
              </div>
              <div class="order-products">
                <strong>Products:</strong>
                <ul>
                  ${order.products
                    .map(
                      (product) => `
                      <li>
                        <img src="${product.image}" alt="${product.name}" style="width:50px; height:50px; object-fit:cover;"/>
                        ${product.name} - PKR ${product.price} x ${product.quantity}
                      </li>`
                    )
                    .join("")}
                </ul>
              </div>
              <div class="order-footer">
                <strong>Total Amount:</strong> PKR ${order.totalAmount}<br/>
                <strong>Order Notes:</strong> ${order.orderNotes || "None"}
              </div>
              <button class="delete-order-btn" onclick="deleteOrder('${
                order._id
              }', ${index})">Delete Order</button>
            </div>
          `
              )
              .join("");
          }

          document
            .getElementById("add-product-btn")
            .addEventListener("click", async function () {
              const name = document.getElementById("product-name").value;
              const description = document.getElementById(
                "product-description"
              ).value;
              const price = document.getElementById("product-price").value;
              const stock = document.getElementById("product-stock").value;
              // const link = document.getElementById("product-link").value;
              const imageUpload =
                document.getElementById("imageUpload").files[0]; // Get the selected file

              const formData = new FormData();
              formData.append("name", name);
              formData.append("description", description);
              formData.append("price", price);
              formData.append("stock", stock);
              // formData.append("productlink", link);
              formData.append(
                "category",
                document.getElementById("options").value
              );
              formData.append(
                "brand",
                document.getElementById("options2").value
              );
              formData.append("image", imageUpload); // Append the image file

              try {
                const response = await fetch(
                  "http://localhost:5000/api/products",
                  {
                    method: "POST",
                    body: formData,
                  }
                );

                if (!response.ok) {
                  throw new Error("Failed to create product");
                }

                const newProduct = await response.json();
                fetchProducts(); // Refresh the product list
              } catch (error) {
                console.error("Failed to add product:", error);
              }
            });

          // Add User Form Submission
          document
            .getElementById("add-user-btn")
            .addEventListener("click", async function () {
              const name = document.getElementById("name").value;
              const email = document.getElementById("email").value;
              const password = document.getElementById("password").value;
              const confirmPassword =
                document.getElementById("confirm-password").value;
              const address = document.getElementById("address").value;
              const contact = document.getElementById("contact").value;
              const role = document.getElementById("user-role").value;

              if (password !== confirmPassword) {
                alert("Passwords do not match");
                return;
              }

              const userData = {
                name,
                email,
                password,
                address,
                contact,
                role,
              };

              try {
                const response = await fetch(
                  "http://localhost:5000/api/users/manual-create",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(userData),
                  }
                );

                if (!response.ok) {
                  throw new Error("Failed to create user");
                }

                const newUser = await response.json();
                console.log("New user added:", newUser);
                fetchUsers(); // Refresh the user list
                document.getElementById("add-user-form").reset(); // Clear form
              } catch (error) {
                console.error("Failed to add user:", error);
              }
            });
        });
      </script>
    </div>
  </body>
</html>
